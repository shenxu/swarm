<!DOCTYPE html>
<html>
<head>
	<title>Jugnoo Swarm</title>
	<link href="style.css" rel="stylesheet" />
	<script src="jquery-1.7.2.min.js" type="text/javascript"></script>
</head>
<script>
var items = [], imgs=[], finals = [], WIDTH = $(window).width(), HEIGHT = $(window).height(), POPUP
for(var i=0;i<1;i++){
	imgs[i] =[]
	for(var j=0;j<4;j++){
		var img = new Image()
		img.src = "images/shape"+ i + j +".png"
		imgs[i].push(img)
	}
	imgs.push(imgs[i])
}
var makePoint = function(x, y, range) {
	range = range ? range : 100
	var rangex = Math.round(Math.random() * range)
	var rangey = Math.round(Math.random() * range)
	return {x: Math.round(x + rangex), y: Math.round(y + rangey)}
}
var overlap = function(p1, p2, r1, r2){
	var overlap = false, xs = ys = 0;

	xs = p2.x - p1.x;
	xs = xs * xs;
	ys = p2.y - p1.y;
	ys = ys * ys;
	if(Math.round(Math.sqrt(xs + ys)) < (r1 + r2)) overlap = true
	
	return overlap
}
var swing = function(a) {
	return -Math.sin(a * Math.PI) / 2 + 0.5;
}
var bezier = function(t, p0, p1, p2, p3) {
	var cx = 3 * (p1.x - p0.x)
	var bx = 3 * (p2.x - p1.x) - cx;
	var ax = p3.x - p0.x - cx - bx;

	var cy = 3 * (p1.y - p0.y);
	var by = 3 * (p2.y - p1.y) - cy;
	var ay = p3.y - p0.y - cy - by;

	var xt = ax*(t*t*t) + bx*(t*t) + cx*t + p0.x;
	var yt = ay*(t*t*t) + by*(t*t) + cy*t + p0.y;
	
	return [xt, yt]
}
var requestAnimFrame = new function() {
	return window.requestAnimationFrame || 
		window.webkitRequestAnimationFrame || 
		window.mozRequestAnimationFrame || 
		window.oRequestAnimationFrame || 
		window.msRequestAnimationFrame || 
		function(callback) {
			window.setTimeout(callback, 1000 / 60);
		};
}
$.fn.tpl = function(tpl, data) {
	var html = $(tpl).html().replace(/\{\{(.+?)\}\}/gim, function(match, key) {
		return data ? data[key] || "" : ""
	})
	this.html(html)
	return this
}

var start, step = [0, 0], tempitems=[]
function animate(ctx) {
	var delta = new Date
	items.forEach(function(item) {ctx.clearRect(item.step[0], item.step[1], img.width, img.height)})
	recalc(finals)

	items.forEach(function(item) {
		var color = item.img.src.substr(item.img.src.length - 6, 1)
		item.step = bezier(Math.min(1, (delta - item.start) * item.delay / 400), item.p0, item.p1, item.p2, item.p3)
		ctx.drawImage(item.img, item.step[0], item.step[1], item.size, item.size)
		if (Math.round(item.step[0]) == Math.round(item.p3.x) && Math.round(item.step[1]) == Math.round(item.p3.y)) {
			item.count++
			item.p0 = item.p3
			item.p1 = {x: 2 * item.p3.x - item.p2.x, y: 2 * item.p3.y - item.p2.y}
			if(color == 1){  //red feeds
				if (item.count == 1) 
					item.p2 = item.p3 = {x:WIDTH*0.98, y: 0}
				else if (item.count == 2) { //coordinates: calculate by y:speed/x:age
					item.p2 = makePoint(WIDTH*0.9, HEIGHT/2)
					item.p3 = makePoint(WIDTH*2/3 - (item.age*80), HEIGHT*0.35 - (item.speed*3.5), 320)
					if(item.p3.y < 20) item.p3.y = 50;
					item.p3.r = item.size * 0.55
					finals.push(item.p3)
				}
			}
			else { //blue feeds, distance away from red feeds
				if (item.count == 1)
					item.p2 = item.p3 = {x: 0, y: 0}
				else if (item.count == 2) {
					item.p2 = makePoint(WIDTH/9, HEIGHT/2)
					item.p3 = makePoint(WIDTH/2 - (item.age*80), HEIGHT*0.5 - (item.speed*3.4), 280)
					item.p3.r = item.size * 0.55
					finals.push(item.p3)
				}
			}
			if (item.count < 3) item.start = new Date
		}
	})
	requestAnimFrame(function() {
		animate(ctx)
		// items.forEach(function(item){
		// 			if(item.count == 3){
		// 				tempitems.push(item)
		// 				for(var j=0;j<tempitems.indexOf(item);j++){
		// 					while(overlap(tempitems[j].p3, item.p3, tempitems[j].size, item.size)){
		// 						item.p3.x++
		// 						item.p3.y++
		// 					}
		// 				}
		// 			}
		// 		})
	})
}

function recalc(nodes) {
	for (var i = 0; i < nodes.length; i++) {
		for (var j = 0; j < nodes.length; j++) {
			if (i == j) {
				continue;
			}

			pack(nodes[i], nodes[j]);
		}
	}
};
function normalize(v) {
	var magnitude = Math.sqrt((v.x * v.x) + (v.y * v.y));

	v.x = v.x / magnitude;
	v.y = v.y / magnitude;
	return v
};
function mult(v, m) {
	v.x *= m;
	v.y *= m;
	return v
};
function pack(a, b) {
	if (intersects(a, b)) {
		var v = {x:0, y: 0}
		v.x = a.x - b.x;
		v.y = a.y - b.y;
		var d = (v.x * v.x) + (v.y * v.y);

		v = normalize(v);
		v = mult(v, (a.r + b.r + 1 - Math.sqrt(d)) * 0.25);

		a.x += v.x;
		a.y += v.y;

		b.x -= v.x;
		b.x -= v.y;
	}
}
function distance(ax, ay, bx, by) {
	var dx = ax - bx;
	var dy = ay - by;

	return Math.sqrt((dx*dx) + (dy*dy));
};
function intersects(a, b) {
	var d = distance(a.x, a.y, b.x, b.y);
	return (d < (a.r + b.r + 1));
}

var getData = function(){ // 0-twitter,1-post, 2-article, 3-video
	$.getJSON("Video.txt", function(data) {
		draw(3, data)
	}),
	$.getJSON("Post.txt", function(data) {
		draw(0, data)
	}),
	$.getJSON("Article.txt", function(data){
		draw(2, data)
	})
}

var draw = function(shape, data){
	var today = new Date;
	data.forEach(function(item){
		var age = today - new Date(item.published_date) //age = (currentDate - publishDate)
		var color = 0
		var r = Math.round(Math.random()*10) //size depends on velocity and recency, needs to be calculated according age&speed. 
											 //speed = (number of views)/age
		var d = r * 0.01 + Math.random() * 0.1 + 0.1
		var popup = $("<div class='modalcontainer shadow'><a class='modalcloser' href='javascript:;'></a><div class='modalbody'></div></div>")
		popup.find(".modalbody").tpl("#tpl-" + shape, data)

		items.push({img:imgs[color][shape], x:120, y:120, step:[0, 0], p0:{x:0, y:0}, p1:{x:150, y:200}, p2:makePoint(WIDTH/6, HEIGHT), p3: makePoint(WIDTH/4, HEIGHT/2), age:10-r, speed:100/(11-r), size:r*5, delay:d, start:now, count:0, popup:popup})
	})
}

function genPopup(e) {
	var p = {x : e.clientX, y : e.clientY};
	items.forEach(function(el) {
		if (overlap(p, el.p3, 0, el.size)) {
			//drift()
			POPUP = el.popup
			POPUP.appendTo(document.body)
				.css({
					position: "absolute",
					left: WIDTH/2 - (POPUP.width()/2),
					top: HEIGHT/2 - (POPUP.height()/2)
				})
				.fadeIn()
			
			$(".modalcloser").click(function(e){
				e.preventDefault()
				$(e.target).closest(".modalcontainer").remove()
			})
        }// else
			//drift()
    })
}
function drift() {
	//BUBBLE.not(".pop").unbind("click mouseenter").stop(true).animate({top: -BUBBLE.outerHeight(true)}, 1000, queue)
	//BUBBLE = $()
}

$(function(){
	canvas = $("#swarm")[0];
	var ctx = canvas.getContext('2d')
	now = new Date
	canvas.width = WIDTH
	canvas.height = HEIGHT
	
	getData()
	
	animate(ctx)
	
	$(document).die("click").bind("click", genPopup)
})
</script>
<body>
	<canvas id="swarm"></canvas>
	<script id="tpl-0" type="text/x-jquery-template">
		<div class="userdiv clearfix">
			<div class="usericon"><img src="{{author.profile_image}}" /></div>
			<div class="usercomment">
				<p>{{content}} - {{author.name}}</p>
				<p><small>{{published_date}}</small></p>
			</div>
		</div>
	</script>
	<script id="tpl-1" type="text/x-jquery-template">
		
	</script>
	<script id="tpl-2" type="text/x-jquery-template">
		
	</script>
	<script id="tpl-3" type="text/x-jquery-template">
		<h3>{{title}}</h3>
		<iframe width="560" height="315" src="http://www.youtube.com/embed/{{video_id}}" frameborder="0" allowfullscreen></iframe>
		<p>{{description}}</p>
	</script>
</body>
</html>