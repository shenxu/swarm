<!DOCTYPE html>
<html>
<head>
	<title>Jugnoo Swarm</title>
	<link href="style.css" rel="stylesheet" />
	<script src="jquery-1.7.2.min.js" type="text/javascript"></script>
</head>
<script>
var items = [], imgs=[], WIDTH = $(window).width(), HEIGHT = $(window).height(), POPUP
for(var i=0;i<2;i++){
	for(var j=0;j<5;j++){
		var img = new Image()
		img.src = "images/newshape/shape"+ i + j +".png"
		imgs.push(img)
	}
}

$.fn.tpl = function(tpl, data) {
	var date = new Date();
	data["date"] = date.getDate() + "/" + date.getMonth() + "/" + date.getFullYear() + " " + date.getHours() + ":" + date.getMinutes()
	var markup = $(tpl).html()
	for (var i in data) {
		markup = markup.replace(new RegExp("\\{\\{" + i + "\\}\\}", "g"), data[i])
	}
	this.html(markup)
	return this
}

var requestAnimFrame = new function() {
	return window.requestAnimationFrame || 
		window.webkitRequestAnimationFrame || 
		window.mozRequestAnimationFrame || 
		window.oRequestAnimationFrame || 
		window.msRequestAnimationFrame || 
		function(callback) {
			window.setTimeout(callback, 1000 / 60);
		};
}
function swing(a) {
	return -Math.sin(a * Math.PI) / 2 + 0.5;
}
function bezier(t, p0, p1, p2, p3) {
	var cx = 3 * (p1.x - p0.x)
	var bx = 3 * (p2.x - p1.x) - cx;
	var ax = p3.x - p0.x - cx - bx;

	var cy = 3 * (p1.y - p0.y);
	var by = 3 * (p2.y - p1.y) - cy;
	var ay = p3.y - p0.y - cy - by;

	var xt = ax*(t*t*t) + bx*(t*t) + cx*t + p0.x;
	var yt = ay*(t*t*t) + by*(t*t) + cy*t + p0.y;
	
	return [xt, yt]
}

var makePoint = function(x, y, range) {
	range = range ? range : 100
	var rangex = Math.round(Math.random() * range)
	var rangey = Math.round(Math.random() * range)
	return {x: Math.round(x + rangex), y: Math.round(y + rangey)}
}

var overlap = function(p1, p2, r1, r2){
	var overlap = false, xs = ys = 0;

	xs = p2.x - p1.x;
	xs = xs * xs;
	ys = p2.y - p1.y;
	ys = ys * ys;

	if(Math.sqrt(xs + ys) < (r1 + r2)) overlap = true
	
	return overlap
}
var start, step = [0, 0], tempitems=[]
function animate(ctx) {
	var delta = new Date
	items.forEach(function(item) {ctx.clearRect(item.step[0], item.step[1], img.width, img.height)})

	items.forEach(function(item) {
		var color = item.img.src.substr(item.img.src.length - 6, 1)
		item.step = bezier(Math.min(1, (delta - item.start) * item.delay / 400), item.p0, item.p1, item.p2, item.p3)
		ctx.drawImage(item.img, item.step[0], item.step[1], item.size, item.size)
		if (Math.round(item.step[0]) == Math.round(item.p3.x) && Math.round(item.step[1]) == Math.round(item.p3.y)) {
			item.count++
			item.p0 = item.p3
			item.p1 = {x: 2 * item.p3.x - item.p2.x, y: 2 * item.p3.y - item.p2.y}
			if(color == 1){  //red feeds
				if (item.count == 1) 
					item.p2 = item.p3 = {x:WIDTH*0.98, y: 0}
				else if (item.count == 2) { //coordinates: calculate by y:speed/x:age
					item.p2 = makePoint(WIDTH*0.9, HEIGHT/2)
					item.p3 = makePoint(WIDTH*2/3 - (item.age*80), HEIGHT*0.35 - (item.speed*3.5), 320)
					if(item.p3.y < 20) item.p3.y = 50;
				}
			}
			else { //blue feeds, distance away from red feeds
				if (item.count == 1)
					item.p2 = item.p3 = {x: 0, y: 0}
				else if (item.count == 2) {
					item.p2 = makePoint(WIDTH/9, HEIGHT/2)
					item.p3 = makePoint(WIDTH/2 - (item.age*80), HEIGHT*0.5 - (item.speed*3.4), 280)
				}
			}
			if (item.count < 3) item.start = new Date
		}
	})
	requestAnimFrame(function() {
		animate(ctx)
		// items.forEach(function(item){
		// 			if(item.count == 3){
		// 				tempitems.push(item)
		// 				for(var j=0;j<tempitems.indexOf(item);j++){
		// 					while(overlap(tempitems[j].p3, item.p3, tempitems[j].size, item.size)){
		// 						item.p3.x++
		// 						item.p3.y++
		// 					}
		// 				}
		// 			}
		// 		})
	})
}
var draw = function(){
	var video = [], twitter = [], post = [], article = []
	$.getJSON("Video.txt", function(data) {
	
	}),
	$.getJSON("Post.txt", function(data) {
		
	}),
	$.getJSON("Article.txt", function(data) {
	
	})

	function getData(shape) {
		switch(shape){
			case 
		}
		if (shape == 0 || shape == 2) return twitter.shift() || twitterfiller
		else if (shape == 3 || shape == 4) return youtube.shift() || youtubefiller
	}
}

function genPopup(e) {
	var p = {x : e.clientX, y : e.clientY};
	
	items.forEach(function(el) {
		if (overlap(p, el.p3, 0, el.size)) {
			//drift()
			POPUP = el.popup
			POPUP.appendTo(document.body)
				.css({
					position: "absolute",
					left: WIDTH/2 - (POPUP.width()/2),
					top: HEIGHT/2 - (POPUP.height()/2)
				})
				.fadeIn()
			
			$(".modalcloser").click(function(e){
				e.preventDefault()
				$(e.target).closest(".modalcontainer").remove()
			})
        }// else
			//drift()
    })
}
function drift() {
	//BUBBLE.not(".pop").unbind("click mouseenter").stop(true).animate({top: -BUBBLE.outerHeight(true)}, 1000, queue)
	//BUBBLE = $()
}

$(function(){
	canvas = $("#swarm")[0];
	var ctx = canvas.getContext('2d')
	now = new Date
	canvas.width = WIDTH
	canvas.height = HEIGHT
	
	for(var i=0;i<10;i++){ //color and shape: can be different number, needs to be calculate according the json data
		for(var j=0;j<30;j++){
			var r = Math.round(Math.random()*10) //size depends on velocity and recency, needs to be calculated according age&speed. 
												 //age = (currentDate - publishDate), speed = (number of views)/age
			var d = r * 0.01 + Math.random() * 0.1 + 0.1
			var shape = imgs[i].src.substr(imgs[i].src.length - 5, 1)
			var popup = $("<div class='modalcontainer shadow'><a class='modalcloser' href='javascript:;'></a><div class='modalbody'></div></div>")
						.find(".modalbody")
						//.tpl("#tpl-" + shape, getData(shape))
			items.push({img:imgs[i], x: 120, y: 120, step: [0, 0], p0:{x:0, y:0}, p1:{x:150, y:200}, p2: makePoint(WIDTH/6, HEIGHT), p3: makePoint(WIDTH/4, HEIGHT/2), age:10-r, speed:100/(11-r), size: r*5, delay:d, start:now, count:0, popup:popup})
		}
	}
	
	animate(ctx)
	
	$(document).die("click").bind("click", genPopup)
})
</script>
<body>
	<canvas id="swarm"></canvas>
	<script id="tpl-0" type="text/x-jquery-template">
		<div class="userdiv clearfix">
			<div class="usericon"><img src="images/scotialogo.jpg" /></div>
			<div class="usercomment">
				<p>{{title}}</p>
				<p><small>{{published}}</small></p>
			</div>
		</div>
		<div class="modalcomment">
			<input type="text" />
			<button>Send</button>
		</div>
	</script>
	<script id="tpl-1" type="text/x-jquery-template">
		<div class="imagecontainer"><img src="images/{{url}}" width="360" /></div>
		<p> {{comment}}</p><br />
		<div class="modalcomment">
			<input type="text" />
			<button>Send</button>
		</div>
	</script>
	<script id="tpl-2" type="text/x-jquery-template">
		<div class="userdiv clearfix">
			<div class="usericon"><img src="images/scotialogo.jpg" /></div>
			<div class="usercomment">
				<p>{{title}}</p>
				<p><small>{{published}}</small></p>
			</div>
		</div>
		<div class="modalcomment">
			<input type="text" />
			<button>Send</button>
		</div>
	</script>
	<script id="tpl-3" type="text/x-jquery-template">
		<iframe width="560" height="315" src="http://www.youtube.com/embed/{{id}}" frameborder="0" allowfullscreen></iframe>
		<div class="modalcomment">
			<input type="text" />
			<button>Send</button>
		</div>
	</script>
	<script id="tpl-4" type="text/x-jquery-template">
		<iframe width="560" height="315" src="http://www.youtube.com/embed/{{id}}" frameborder="0" allowfullscreen></iframe>
		<div class="modalcomment">
			<input type="text" />
			<button>Send</button>
		</div>
	</script>
</body>
</html>